extends layout

block append code
    - active.editAssignment="active"
    - active.assignment="active"
    - menu.assignment="menu-open"
    link(rel="stylesheet", href="/adminLTE/dist/css/daterangepicker.css")
    script(src="/adminLTE/dist/js/moment.min.js")
    script(src="/adminLTE/dist/js/daterangepicker.min.js")
    link(href="https://fonts.googleapis.com/css?family=Crimson+Text&display=swap" rel="stylesheet")
    script(src="https://cdn.quilljs.com/1.3.6/quill.js")
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js")
    link(rel="stylesheet", href="https://cdn.quilljs.com/1.3.6/quill.snow.css")
    style.
        #myModal label,#myModal p{
            font-family: 'Crimson Text', serif;
            font-size:20px;
            font-weight:normal;
        }
        
  




block content
    #editAssignment
        .card.card-primary
                .card-header 
                    h3.card-title Edit Assignment
                .card-body
                    .col-3(style="margin:auto;")
                        select#sem(name="sem").form-control.custom-select.type
                             option(selected,disabled) Select Semester
                             each i in current
                                option(value=i.id) #{i.sem}, Set #{i.id.substr(9)}
                    br
                    br
                    form.form-horizontal
                        #details
                    .container
                        .modal#myModal
                            .modal-dialog.modal-xl
                                form#ques(onsubmit="return submitFormAdd()")
                                    .modal-content
                                        .modal-header
                                            h4.modal-title New Question  
                                            button.close(type='button' data-dismiss='modal') Ã—
                                            
                                        .modal-body
                                                .box
                                                    table.table
                                                        tbody
                                                            tr
                                                                td(style="width:150px;")
                                                                    label Question name:
                                                                td
                                                                    input#name(type='text' name='name' required style="width:50%").form-control
                                                            tr
                                                                td(style="width:150px;")
                                                                    label Problem Statement:
                                                                td
                                                                    div#statement-editor(style="height:120px;")
                                                                    script.
                                                                        const editor = new Quill('#statement-editor', {
                                                                        modules: { toolbar: [
                                                                        [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
                                                                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],    
                                                                        ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
                                                                        ['blockquote'],
                                                                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                                                        [{ 'script': 'sub'}, { 'script': 'super' }], 
                                                                        ['image', 'code-block','formula'],     			                // superscript/subscript
                                                                        [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
                                                                        [{ 'direction': 'rtl' }],                         // text direction
                                                                        [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                                                                        [{ 'font': [] }],
                                                                        [{ 'align': [] }],
                                                                        ['clean'] 
                                                                            ] },
                                                                            theme: 'snow'
                                                                            });
                                                                
                                                            tr
                                                                td(style="width:150px;")
                                                                    label Constraints:
                                                                td
                                                                    textarea.form-control#constraints(rows='5' name='constraints' cols='50')
                                                        
                                                            tr
                                                                td(style="width:150px;")
                                                                    label Input format:
                                                                td
                                                                    textarea.form-control#i_format(rows='5' name='i_format' cols='50' required)
                                                    
                                                            tr
                                                                td(style="width:150px;")
                                                                    label Output format:
                                                                td
                                                                    textarea.form-control#o_format(rows='5' name='o_format' cols='50' required)
                                                    hr    
                                                
                                                    #samplecase
                                                        label.tc Sample Testcases:
                                                        input#btSampleAdd.bt.btn.btn-info.btn-sm(type='button' value='Add Sample Case' style="margin-right:20px;margin-left:20px;")
                                                        input#btSampleRemove.bt.btn.btn-danger.btn-sm(type='button' value='Remove Testcase')
                                                        .t_case
                                                            p Sample Testcase 1
                                                            textarea.form-control.input#i_sample1(rows='5' name='i_sample1' cols='50' required placeholder='Input' style="margin-bottom:10px;")
                                                            textarea.form-control.input#o_sample1(rows='5' name='o_sample1' cols='50' required placeholder='Output')
                                                            p Explanation
                                                            textarea.form-control.ex_box#explaination(name='explanation' rows='5' cols='107' style="margin-bottom:10px" required)
                                                    #testcase
                                                        label.tc Testcases:
                                                        input#btAdd.bt.btn.btn-info.btn-sm(type='button' value='Add Testcase' style="margin-right:20px;margin-left:20px;")
                                                        input#btRemove.bt.btn.btn-danger.btn-sm(type='button' value='Remove Testcase')
                                                        br
                                                        .t_case
                                                            p Testcase 1
                                                            textarea.form-control.input#i_testcase1(rows='5' name='i_testcase1' cols='50' required placeholder='Input' style="margin-bottom:10px;")
                                                            textarea.form-control.input#o_testcase1(rows='5' name='o_testcase1' cols='50' required placeholder='Output')
                                                            p Points
                                                            input.form-control(style="width:15%;" name="points" id="points0" type="text" placeholder="Ex: 10" required)
                                                    textarea(name="statement" id="es" style="display:none;")
                                            
                                        .modal-footer
                                            input.btn.btn-success(type='submit' value="ADD")
                                            button.btn.btn-secondary(type='button' data-dismiss='modal') Close
                    .modal.fade#loading(data-backdrop="static" role="dialog" tabindex="-1" data-keyboard="false")
                        .modal-dialog.modal-dialog-centered.text-center(role="document")
                            span.fas.fa-circle-notch.fa-spin.fa-3x.w-100
                
                            
        .card.card-primary
                .card-header 
                    h3.card-title Questions
                .card-body.table-responsive.p-0
                    table.table.table-hover
                        thead
                            tr
                                th ID
                                th Question Name
                                th Edit
                                th Delete
                        tbody#qlist
    
    .container
        .modal#edit
            .modal-dialog.modal-xl
                form#ques-edit(onsubmit="return editForm()")
                    .modal-content
                        .modal-header
                            h4.modal-title New Question  
                            button.close(type='button' data-dismiss='modal') Ã—
                            
                        .modal-body
                                .box
                                    table.table
                                        tbody
                                            tr
                                                td(style="width:150px;")
                                                    label Question name:
                                                td
                                                    input#name-e(type='text' name='name' required style="width:50%").form-control
                                            tr
                                                td(style="width:150px;")
                                                    label Problem Statement:
                                                td
                                                    div#statement-editor-edit(style="height:120px;")
                                                    script.
                                                        const editor_edit = new Quill('#statement-editor-edit', {
                                                        modules: { toolbar: [
                                                        [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
                                                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],    
                                                        ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
                                                        ['blockquote'],
                                                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                                        [{ 'script': 'sub'}, { 'script': 'super' }], 
                                                        ['image', 'code-block','formula'],     			                // superscript/subscript
                                                        [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
                                                        [{ 'direction': 'rtl' }],                         // text direction
                                                        [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                                                        [{ 'font': [] }],
                                                        [{ 'align': [] }],
                                                        ['clean'] 
                                                            ] },
                                                            theme: 'snow'
                                                            });
                                                
                                            tr
                                                td(style="width:150px;")
                                                    label Constraints:
                                                td
                                                    textarea#constraints-e.form-control(rows='5' name='constraints' cols='50')
                                        
                                            tr
                                                td(style="width:150px;")
                                                    label Input format:
                                                td
                                                    textarea.form-control#i_format-e(rows='5' name='i_format' cols='50' required)
                                    
                                            tr
                                                td(style="width:150px;")
                                                    label Output format:
                                                td
                                                    textarea.form-control#o_format-e(rows='5' name='o_format' cols='50' required)
                                    hr    
                                
                                    
                                    textarea(name="statement" id="es" style="display:none;")
                            
                        .modal-footer
                            input.btn.btn-success(type='submit' value="SAVE")
                            button.btn.btn-secondary(type='button' data-dismiss='modal') Close
                            

    .modal.fade#delete(tabindex ="-1" role="dialog" )
        .modal-dialog.modal-sm
            .modal-content
                .modal-header
                    h4.modal-title Delete Question
                .modal-body
                    p Delete the following question?
                    #dbody
                .modal-footer
                    button.btn.btn-danger(type='button' data-dismiss='modal' onclick="deleteQ()") Delete
                    button.btn.btn-secondary(type='button' data-dismiss='modal') Close


                        
                
    script.
        function setDateTime(s,e){
            $('input[name="duration"]').daterangepicker({
                timePicker: true,
                startDate: s,
                endDate: e,
                locale: {
                format: 'YYYY/MM/DD hh:mm A'
                }
            });
        }
        $('#sem').change(function (){

            $.get("/assignment/"+document.getElementById("sem").value,function(data,status){
                
                $('#details').empty();
                $('#qlist').empty();
                const sem = '<div class="form-group row"><label class="col-sm-2">Semester &nbsp; : &nbsp;'+data.assignment.sem+'</label><label class="col-sm-2">Set &nbsp; : &nbsp;'+data.assignment.id.substr(9)+'</label></div>';
                const dateTime = '<div class="form-group row"><label class="col-sm-1">Duration</label><div class="col-sm-4"><input type="text" name="duration" class="form-control"></div></div>';
                const batch = '<div class="form-group row"><label class="col-sm-1">Batch</label><div class="col-sm-4"><input readonly type="text" value="'+data.assignment.id.substr(5,4)+'"class="form-control"></div></div>';
                const ready = '<div class="form-group row"><div class="custom-control custom-switch"><label for="customSwitch1" class="custom-control-label">Custom Switch</label><input class="custom-control-input" type="checkbox" id="customSwitch1" value="option1"></div></div>';
                const newQ = '<div class="form-group row"><div class="col-2"><button class="btn btn-primary" type="button" data-toggle="modal" data-target="#myModal">Add New Question</button></div><div class="col-2"><button class="btn btn-primary" type="button">Insert Old Question</button></div></div>';
                document.getElementById("details").innerHTML = sem + dateTime + batch +ready+newQ;
                setDateTime(data.assignment.duration.starts,data.assignment.duration.ends);
                data.questions.forEach(insert);
                function insert(item,index){
                    $("#qlist").append('<tr><td>'+item.qid+'</td><td>'+item.name+'</td><td><a class="fas fa-edit" data-toggle="modal" data-target="#edit" data-id="'+item.qid+'" style="color:dimgrey;" href=""></a></td><td><a class="fas fa-trash" style="color:red;" data-toggle="modal" data-target="#delete" href="" data-id="'+item.qid+'" data-name="'+item.name+'"></a></td></tr>');
                }
                
            });
        });

        

        $(document).ready(function() {
        
            var iCnt = 0;
            var count = 0;
            // CREATE A "DIV" ELEMENT AND DESIGN IT USING jQuery ".css()" CLASS.
            var container = $(document.createElement('div')).css({
                padding: '5px',margin: '20px'
                
            });
        
            $('#btSampleAdd').click(function() {
        
                    iCnt = iCnt + 1;
        
                    count = count +1;
        
        
                    // ADD TEXTBOX.
                    $(container).append('<p id=p' + count +'>Sample Testcase ' + (count+1) + '</p>');
                    $(container).append('<textarea name="i_sample1" required rows="5" cols="50"  class="input form-control" id=tb' + iCnt + ' placeholder="Input" style="margin-bottom:10px;" ></textarea>');
                    iCnt = iCnt + 1;
                    $(container).append('<textarea name="o_sample1" required rows="5" cols="50"  class="input form-control" id=tb' + iCnt + ' placeholder="Output" ></textarea>');
                    
                    // ADD BOTH THE DIV ELEMENTS TO THE "main" CONTAINER.
                    $('#samplecase').after(container);
                
            });
        
            // REMOVE ONE ELEMENT PER CLICK.
            $('#btSampleRemove').click(function() {
                if (iCnt != 0) 
                {
                
                $('#tb' + iCnt).remove(); iCnt = iCnt - 1; 
                $('#tb' + iCnt).remove(); iCnt = iCnt - 1;
                $('#p' + count).remove();count = count -1;
                
                }
            
                
            });
        
            
        });
        
        $(document).ready(function() {
        
            var iCnt = 0;
            var count = 0;
            // CREATE A "DIV" ELEMENT AND DESIGN IT USING jQuery ".css()" CLASS.
            var container = $(document.createElement('div')).css({
                padding: '5px', margin: '20px'
                
            });
        
            $('#btAdd').click(function() {
        
                    iCnt = iCnt + 1;
        
                    count = count +1;
        
        
                    // ADD TEXTBOX.
                    $(container).append('<p id=p' + count +'>Testcase ' + (count+1) + '</p>');
                    $(container).append('<textarea name="i_testcase1" required rows="5" cols="50"  class="input form-control" id=tb' + iCnt + ' placeholder="Input" style="margin-bottom:10px;"></textarea>');
                    iCnt = iCnt + 1;
                    $(container).append('<textarea name="o_testcase1" required rows="5" cols="50"  class="input form-control" id=tb' + iCnt + ' placeholder="Output" ></textarea>');
                    iCnt = iCnt + 1;
                    $(container).append('<p id=para' +iCnt+ '>Points</p>');
                    iCnt = iCnt + 1;
                    $(container).append('<input class="form-control" required style="width:15%;" name="points" type="text" placeholder="Ex: 10" id="points'+ iCnt +'"/>');
                    // ADD BOTH THE DIV ELEMENTS TO THE "main" CONTAINER.
                    $('#testcase').after(container);
                
            });

            // REMOVE ONE ELEMENT PER CLICK.
            $('#btRemove').click(function() {
                if (iCnt != 0) 
                {
                $('#points' + iCnt).remove(); iCnt = iCnt - 1;
                $('#para' + iCnt).remove(); iCnt = iCnt - 1
                $('#tb' + iCnt).remove(); iCnt = iCnt - 1; 
                $('#tb' + iCnt).remove(); iCnt = iCnt - 1;
                $('#p' + count).remove();count = count -1;
                }
            
            
            });
        
            
        });
        function closeModal() {
            $('#loading').on('shown.bs.modal', function(e) {
                $("#loading").modal("hide");
            });
        }

        function submitFormAdd(){ 
            
            function isQuillEmpty(quill) {
            if ((quill.getContents()['ops'] || []).length !== 1) { return false }
            return quill.getText().trim().length === 0
            }

            if(isQuillEmpty(editor)){
                alert("Problem Statement cannot be empty");
                return false;
            }
            $('#myModal').modal('hide');
            $("#loading").modal('show');
            const aId = document.getElementById('sem').value;
            
            document.getElementById('es').value=encodeURIComponent(JSON.stringify(editor.getContents()));
            $.ajax({
                    type: "POST",
                    url: "/assignment/add",
                    data: $("#ques").serialize()+"&aId="+aId,
                    success: function (data,status, jqXHR) {
                    
                     
                    $("#sem").val(aId).change();
                    closeModal();
                    toastr.success("Question added successfully!");
                    $("#ques")[0].reset();
                    editor.setText("");
                    },
                    error: function (e) {
        
                        alert(e.responseText);
        
                    },
                
                });
                
                return false;
            
            }

            $(document).ready(function() {
                $("#edit").on('show.bs.modal', function(e){
                $("#ques-edit")[0].reset();
                editor_edit.setText("");
                const aId = document.getElementById('sem').value;
                const qid = e.relatedTarget.dataset.id;

                $.get("/assignment/"+aId+"/"+qid,function(data,status){
                    $("#name-e").val(data.name);
                    editor_edit.setContents(JSON.parse(data.statement));
                    $("#constraints-e").val(data.constraints);
                    $("#i_format-e").val(data.input_format);
                    $("#o_format-e").val(data.output_format);

                });    


                });

                $("#delete").on('show.bs.modal', function(e){
                    $("#dbody").empty();
                    $("#dbody").append("<p>"+e.relatedTarget.dataset.name+"</p>");

                });

            });

            function deleteQ(){
                $("#loader").modal('show');

            }